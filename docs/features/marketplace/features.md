# Feature Documentation: Insights Marketplace

**Version:** 1.0
**Status:** Design / P1 Implementation (Core data structure, Consent, Generation Logic), P2 (Payment/Payout)

## 1. Core Purpose

To create a transparent and ethical marketplace where external entities (researchers, businesses, organizations - "Buyers") can purchase access to aggregated, anonymized datasets derived from structured user responses, while users ("Participants/Sellers") who provide consent share in the value generated by their contributions.

## 2. User Experience

### 2.1 Buyer Experience

1.  **Discovery:** Buyers navigate to the `/marketplace` section. They browse a catalog of available structured questions (`questions` table), potentially enriched with metadata like topic, approximate response volume (if above a privacy threshold), and question type. The interface offers filtering (topic, keyword, type) and search capabilities.
2.  **Dataset Building:** Buyers select one or more specific questions (`question.id`) they are interested in adding to their potential dataset purchase.
3.  **Configuration:** For each selected question, the buyer specifies the *number* of unique, anonymized answers they wish to purchase. The system enforces a strict minimum number of answers per question (e.g., **100**) to ensure individual privacy cannot be inferred.
4.  **Pricing & Purchase:** The system dynamically calculates the total price based on the number of questions and the total number of answers requested across all selected questions (e.g., a tiered price per answer). The buyer reviews the configuration and proceeds to checkout. *(Payment integration, e.g., Stripe, is P2)*.
5.  **Data Access:** Upon successful purchase confirmation, the buyer gains access to the requested dataset. This dataset contains the anonymized answers (`survey_responses` data without PII) to the selected questions. Critically, each answer row includes a persistent, unique, but **anonymous user identifier** (e.g., `anon_user_pseudonym`). This allows buyers to correlate responses from the *same* anonymous individual across multiple questions *within their purchased dataset*, enabling cohort or behavioral analysis without revealing any Personally Identifiable Information (PII). Access might be provided via a secure download (e.g., CSV, JSON) or potentially a dedicated data access API *(P3)*.

### 2.2 Participant/Seller Experience

1.  **Consent Management:** Participants access their `/account/settings` or `/profile/marketplace` page. They find clear options to provide explicit, granular **opt-in consent** to allow their *anonymized structured answers* to be included in the marketplace data pool. This consent status is stored persistently (e.g., in the `profiles` table).
2.  **Revocation:** Participants can revoke their consent at any time through the same settings interface. Revocation prevents their data from being included in *future* dataset generations but does not affect previously purchased datasets.
3.  **Contribution Transparency (Optional - P2/P3):** The profile dashboard might display non-specific metrics indicating the user's level of contribution to the consented pool (e.g., "Your answers have contributed to X purchased insight sets").
4.  **Earnings Dashboard:** A dedicated section within the user's profile (`/account/earnings`) displays the actual, real-time earnings attributed to their anonymous contributions based on completed marketplace purchases. It may also show total accumulated earnings, recent earnings, and potentially payout status/history.
5.  **Payouts (P3):** A secure interface allows users meeting a minimum threshold to initiate a payout request for their accumulated earnings (e.g., linking a Stripe Connect account, PayPal).

## 3. Key Functional Components & Features

*   **User Consent Module:**
    *   UI toggle/checkbox in user settings (`/account/settings`).
    *   Secure storage of consent status (`marketplace_consent_structured_answers`: boolean) in the `profiles` table.
    *   Logic to check consent status during dataset generation.
*   **Data Anonymization & Pseudonymization Service:**
    *   **Pseudonym Generation:** A secure backend process (potentially a DB function or triggered process) that generates a unique, persistent, anonymous identifier (`anonymous_user_pseudonym`: text/uuid) for each user *upon first consent*. This pseudonym *must not* be easily reversible or directly derivable from the user's actual `user.id`. Store this securely, potentially in a separate, restricted table linking `user.id` to `anonymous_user_pseudonym`, or use a deterministic hashing method with a secret salt if storage is undesirable (though persistence is often better for tracking).
    *   **Data Pipeline:** Before data is made available for purchase queries, a process (or database view with appropriate security) selects relevant columns from `survey_responses`, joins to get the `anonymous_user_pseudonym` for consented users, and explicitly excludes all PII (`user_id`, potentially `chat_id`, timestamps if too revealing).
*   **Marketplace Catalog & Discovery UI:**
    *   Frontend components for browsing/searching/filtering questions (`/marketplace`).
    *   API endpoint (`/api/marketplace/questions`) to serve filterable question metadata.
*   **Dataset Configuration & Pricing Engine:**
    *   Frontend UI for selecting questions and setting answer counts.
    *   Backend logic to validate requests (min answer count) and calculate pricing.
*   **Payment Integration (P2):**
    *   Integration with a Stripe API (or similar) for handling checkout sessions, payment intents, and webhook confirmations.
    *   Secure handling of payment details (delegated to payment provider).
*   **Dataset Generation Service:**
    *   Backend API endpoint (`/api/marketplace/generate-dataset`) triggered post-purchase.
    *   Takes purchase details (question IDs, answer counts) as input.
    *   Queries the **anonymized data view/table**, filtering by `question_id` and applying `LIMIT` clauses based on requested counts, ensuring only consented data is included.
    *   Uses `ORDER BY random()` or similar to avoid selection bias if more answers are available than requested.
    *   Includes the `anonymous_user_pseudonym` with each answer record.
    *   Packages the result (e.g., generates CSV/JSON).
    *   Provides a secure access method (e.g., generates signed URL for download from secure storage, or grants API access).
*   **Revenue Share & Attribution Engine:**
    *   **Ledger Table:** A database table (e.g., `marketplace_earnings`) to store attributed earnings (`earning_id`, `anonymous_user_pseudonym`, `purchase_id`, `question_id`, `amount_earned`, `timestamp`).
    *   **Attribution Logic:** After dataset generation, identifies the unique `anonymous_user_pseudonym`s included for each question in the purchased set.
    *   **Calculation Logic:** Applies the predefined revenue share percentage to the purchase price. Distributes the share proportionally among the contributing pseudonyms based on the number of their answers included in the final dataset. Inserts records into the `marketplace_earnings` ledger.
*   **User Earnings Display:**
    *   Backend API endpoint (`/api/user/earnings`) to fetch total/recent earnings for the logged-in user by joining `users` -> pseudonym table -> `marketplace_earnings`.
    *   Frontend component in `/account/earnings` to display this data.
*   **Payout Mechanism (P3):**
    *   Integration with a payout provider (e.g., Stripe Connect, PayPal Payouts API).
    *   UI for users to link accounts and request payouts.
    *   Backend logic to process payout requests, update ledger status, and interact with the payout provider API.
*   **Admin Tools (P3):**
    *   Dedicated UI for administrators to manage pricing tiers, view marketplace transactions, manage revenue share percentages, potentially manually approve large dataset requests.

## 4. Data Flow Summary (Purchase & Attribution)

1.  **Buyer:** Configures dataset (Questions + Answer Counts) -> Gets Price -> Initiates Purchase.
2.  **Payment Gateway (P2):** Processes payment -> Sends Confirmation Webhook to Backend.
3.  **Backend (Webhook Handler):** Validates confirmation -> Records Purchase -> Triggers Dataset Generation.
4.  **Dataset Generator:**
    *   Retrieves purchase details.
    *   Queries **Anonymized Data View** (filtering by `question_id`, `consent=true`, applying `LIMIT`s).
    *   Retrieves anonymized answers + `anonymous_user_pseudonym`.
    *   Packages data (CSV/JSON).
    *   Provides access to Buyer (e.g., signed URL).
5.  **Attribution Engine:**
    *   Identifies unique `anonymous_user_pseudonym`s included in the generated dataset.
    *   Calculates revenue share per pseudonym based on contribution.
    *   Inserts earnings records into `marketplace_earnings` ledger.
6.  **User:** Views updated earnings total on their `/account/earnings` dashboard.

## 5. Key Considerations & Tradeoffs

*   **Anonymization Robustness:** Ensuring the `anonymous_user_pseudonym` cannot be reversed or linked back to PII is paramount. The method of generation and storage needs careful security review. Consider potential k-anonymity issues if combining many demographic filters.
*   **Minimum Answer Count:** The minimum (e.g., 100) is crucial for privacy but might limit the immediate availability of purchasable data for niche questions.
*   **Data Freshness vs. Generation Cost:** Generating datasets on-demand ensures freshness but requires compute resources. Pre-aggregating common requests could improve speed but introduces potential staleness.
*   **Revenue Share Complexity:** Accurately calculating and attributing shares proportionally can be complex, especially with varying prices or large datasets. The ledger needs to be robust.
*   **Payout Security (P3):** Implementing secure user payouts involves significant compliance and security overhead (KYC, fraud prevention).
*   **Scalability:** The dataset generation and attribution processes must scale as the number of users, answers, and purchases grows. Efficient database queries and potentially background jobs are necessary.

## 6. Database Schema Impact

*   **`profiles` table:** Add `marketplace_consent_structured_answers` (boolean, default false, not null).
*   **(New Table) `user_pseudonyms` (or similar - secure mapping):**
    *   `user_id` (uuid, PK, FK to `users.id`)
    *   `anonymous_user_pseudonym` (text/uuid, unique, indexed)
    *   `created_at` (timestamp with time zone)
    *(Needs strict RLS/access control)*
*   **`survey_responses` table:** No direct changes needed, but this is the source for anonymized data.
*   **(New Table/View) `anonymized_survey_responses` (or similar VIEW):**
    *   Selects relevant fields from `survey_responses` (e.g., `question_id`, `option_id`, `numeric_value`, `text_value`, `created_at` - *consider timestamp granularity impact on privacy*).
    *   Joins with `profiles` on `user_id` WHERE `profiles.marketplace_consent_structured_answers` is true.
    *   Joins with `user_pseudonyms` on `user_id` to get `anonymous_user_pseudonym`.
    *   Excludes `user_id`.
    *(Needs careful permission definition and RLS, potentially using `SECURITY DEFINER` if needed for pseudonym join)*
*   **(New Table) `marketplace_purchases`:**
    *   `purchase_id` (uuid, PK)
    *   `buyer_identifier` (text/uuid - depends on buyer auth model, maybe link to `users` if buyers are also users)
    *   `purchase_details` (jsonb - structure: `[{question_id: int, answers_requested: int}, ...]`)
    *   `total_price` (numeric)
    *   `payment_status` (text enum: 'pending', 'completed', 'failed')
    *   `dataset_access_info` (text/jsonb - e.g., signed URL, API key reference)
    *   `created_at` (timestamp with time zone)
*   **(New Table) `marketplace_earnings`:**
    *   `earning_id` (uuid, PK)
    *   `anonymous_user_pseudonym` (text/uuid, indexed, FK to `user_pseudonyms.anonymous_user_pseudonym` - *note: FK on non-PK requires target column to be unique*)
    *   `purchase_id` (uuid, FK to `marketplace_purchases.purchase_id`)
    *   `question_id` (integer, FK to `questions.id`)
    *   `answer_contribution_count` (integer - number of answers from this user for this question included in the specific purchase)
    *   `amount_earned` (numeric)
    *   `payout_status` (text enum - default 'pending', 'requested', 'processing', 'paid', 'failed')
    *   `payout_id` (nullable uuid, FK to a future `payouts` table)
    *   `created_at` (timestamp with time zone)
*   **(New Table - P3) `payouts`:**
    *   `payout_id` (uuid, PK)
    *   `user_id` (uuid, FK to `users.id`)
    *   `amount` (numeric)
    *   `status` (text enum: 'requested', 'processing', 'completed', 'failed')
    *   `provider_reference` (text - e.g., Stripe Transfer ID)
    *   `requested_at` (timestamp with time zone)
    *   `processed_at` (timestamp with time zone, nullable)

This detailed description outlines the functionality and technical considerations for building a real, value-generating Insights Marketplace within Global Pulse.